Sun 02 Aug 2020 07:41:52 PM +05

Общая проблема: необходимо учесть параметр продвижения (propagation) для точек
монтирования в Linux. Важно, как минимум, уметь устанавливать им режим private.
В текущем коде chroot-tool параметры продвижения учитываются, как обычные опции
монтирования, и это нормально работало, продвижение устанавливалось нормально и
не менялось при необходимых операциях с chroot.

Положение изменилось с началом использования systemd. Systemd по некоторым
причинам (пока не понятным), меняет продвижения точек монтирования, они
перестают соответствовать указанным в настройках для chroot. Это приводит к
попытке ремонтирования (unmount; mount) точки монтирования, и, как следствие, к
ошибкам, потому что это происходит и при включенных chroot, с запущенными в них
процессах (то есть, операции ремонтирования пользователи не ожидают).

Ситуацию можно исправить. Нормальный способ установки опций продвижения для
точек монтирования -- это при помощи --make параметров утилиты mount:

  mount --make-private /xyz

Эту операцию можно выполнять без ремонтирования точки. Решение многогранное.

Решение.

1. Нужно некоторым образом различать параметры продвижения.

  Эти параметры выбраны так, что их можно смешивать с прочими параметрами mount.
  Там нет пересечений, поэтому выделить параметры продвижения из общего списка
  параметров точки монтирования в gen-bindings и filter-bindings не сложно. Не
  сложно извлечь их и из переменной PROPAGATION, возвращаемой findmnt.

2. В filter-bindings нужно разделить проверки точки монтирования, опций
монтирования и параметров продвижения.

  Кое-какая подготовительная работа для этого сделана, поэтому не сложно. Здесь
  нужно будет усложить структуру mount-reсords, и, наверное, привести к
  нормальному виду понятие о множестве опций. Добавить процедуры для работы с
  множествами.

3. Самое сложное: нужно научить chroot-tool.sh разбираться в том, что следует
делать. Желательно так, чтобы код на Bash не пришлось делать шибко умным. В Bash
с этим тяжело.

  Можно поступить так: разбить в filter-bindings весь список работ для
  chroot-tool.sh на 3 группы:

    3.1. Полное монтирования (потому что точки нет в списке).

    3.2. Ремонтирование (потому что неверные параметры монтирования). Это уже
    есть, обозначено флагом R в списке работ.

    3.3. Изменение параметров продвижения. Можно propagate. Такую
    запись можно упихать в стандартную 4-ёх элементную запись о задании:

      propagate
      флаги для make: --make-private, --make-slave, ... etc
      source: не используется
      target

  В filter-bindings много логики разбиения общего плана работ на части, поэтому
  общий план можно упорядочить так:

    3.4. монтирование;
    3.5. ремонтирование по каким-то причинам;
    3.6. установка параметров продвижения.
  
  В chroot-tool.sh каждая операция монтирования независима, поэтому chroot-tool
  об этой структуре может и не знать.

Выглядит, как план работ. Можно начинать
